{"id":"61664","content":"package com.microsoft.migration.assets.config;\r\n\r\nimport org.springframework.amqp.core.AcknowledgeMode;\r\nimport org.springframework.amqp.core.Binding;\r\nimport org.springframework.amqp.core.BindingBuilder;\r\nimport org.springframework.amqp.core.DirectExchange;\r\nimport org.springframework.amqp.core.Queue;\r\nimport org.springframework.amqp.core.QueueBuilder;\r\nimport org.springframework.amqp.rabbit.config.SimpleRabbitListenerContainerFactory;\r\nimport org.springframework.amqp.rabbit.connection.ConnectionFactory;\r\nimport org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;\r\nimport org.springframework.amqp.support.converter.MessageConverter;\r\nimport org.springframework.boot.autoconfigure.amqp.SimpleRabbitListenerContainerFactoryConfigurer;\r\nimport org.springframework.context.annotation.Bean;\r\nimport org.springframework.context.annotation.Configuration;\r\n\r\n@Configuration\r\npublic class RabbitConfig {\r\n    public static final String IMAGE_PROCESSING_QUEUE = \"image-processing\";\r\n\r\n    // Dead letter queue configuration for the retry mechanism\r\n    public static final String RETRY_EXCHANGE = \"image-processing.retry\";\r\n    public static final String RETRY_QUEUE = \"image-processing.retry\";\r\n    public static final String RETRY_ROUTING_KEY = \"retry\";\r\n    public static final int RETRY_DELAY_MS = 60000; // 1 minute delay\r\n\r\n    @Bean\r\n    public Queue imageProcessingQueue() {\r\n        return QueueBuilder.durable(IMAGE_PROCESSING_QUEUE\r\n)\r\n                .withArgument(\"x-dead-letter-exchange\", RETRY_EXCHANGE)\r\n                .withArgument(\"x-dead-letter-routing-key\", RETRY_ROUTING_KEY)\r\n                .build();\r\n    }\r\n\r\n    @Bean\r\n    public Queue retryQueue() {\r\n        return QueueBuilder.durable(RETRY_QUEUE)\r\n                .withArgument(\"x-dead-letter-exchange\", \"\")\r\n                .withArgument(\"x-dead-letter-routing-key\", IMAGE_PROCESSING_QUEUE\r\n        )\r\n                .withArgument(\"x-message-ttl\", RETRY_DELAY_MS)\r\n                .build();\r\n    }\r\n\r\n    @Bean\r\n    public DirectExchange retryExchange() {\r\n        return new DirectExchange(RETRY_EXCHANGE);\r\n    }\r\n\r\n    @Bean\r\n    public Binding retryBinding() {\r\n        return BindingBuilder\r\n                .bind(retryQueue())\r\n                .to(retryExchange())\r\n                .with(RETRY_ROUTING_KEY);\r\n    }\r\n\r\n    @Bean\r\n    public MessageConverter jsonMessageConverter() {\r\n        return new Jackson2JsonMessageConverter();\r\n    }\r\n\r\n    @Bean\r\n    public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(\r\n            ConnectionFactory connectionFactory,\r\n            SimpleRabbitListenerContainerFactoryConfigurer configurer) {\r\n        SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory();\r\n        configurer.configure(factory, connectionFactory);\r\n        factory.setMessageConverter(jsonMessageConverter());\r\n        factory.setAcknowledgeMode(AcknowledgeMode.MANUAL);\r\n        factory.setDefaultRequeueRejected(false);\r\n        return factory;\r\n    }\r\n}\r\n"}